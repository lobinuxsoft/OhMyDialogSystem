# Deploy Wiki to GitHub Pages (with Roadmap Update)
# Manual trigger only - updates roadmap data and deploys to GitHub Pages
name: Deploy Wiki

on:
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # Job 1: Update roadmap data from GitHub Project
  update-roadmap:
    name: Update Roadmap
    runs-on: ubuntu-latest

    steps:
      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: development
          token: ${{ steps.app-token.outputs.token }}

      - name: Generate Roadmap Data
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          # Fetch project items with custom fields via GraphQL
          PROJECT_DATA=$(gh api graphql -f query='
            query {
              node(id: "PVT_kwHOAVGx6s4BLOYT") {
                ... on ProjectV2 {
                  items(first: 100) {
                    nodes {
                      content {
                        ... on Issue {
                          number
                          title
                          state
                          milestone {
                            number
                            title
                          }
                          labels(first: 10) {
                            nodes {
                              name
                            }
                          }
                        }
                      }
                      fieldValues(first: 10) {
                        nodes {
                          ... on ProjectV2ItemFieldSingleSelectValue {
                            name
                            field {
                              ... on ProjectV2SingleSelectField {
                                name
                              }
                            }
                          }
                          ... on ProjectV2ItemFieldNumberValue {
                            number
                            field {
                              ... on ProjectV2Field {
                                name
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          ')

          # Fetch milestones via REST API
          MILESTONES=$(gh api repos/${{ github.repository }}/milestones --jq '[.[] | {
            number: .number,
            title: .title,
            description: .description,
            open_issues: .open_issues,
            closed_issues: .closed_issues,
            state: .state
          }]')

          # Process with jq to create the final JSON structure
          echo "$PROJECT_DATA" | jq --argjson milestones "$MILESTONES" '
            # Extract items from project
            .data.node.items.nodes as $items |

            # Process each item into a cleaner format
            [
              $items[] |
              select(.content != null) |
              {
                number: .content.number,
                title: .content.title,
                state: .content.state,
                milestone: .content.milestone.title,
                labels: [.content.labels.nodes[].name],
                fields: (
                  [.fieldValues.nodes[] | select(.field != null)] |
                  map({(.field.name): (.name // .number)}) |
                  add // {}
                )
              }
            ] as $issues |

            # Group by Sprint
            ($issues | group_by(.fields.Sprint) |
              map({
                sprint: (.[0].fields.Sprint // "Backlog"),
                issues: (. | sort_by(.fields.Order // 999))
              }) |
              sort_by(
                if .sprint == "Sprint 1" then 1
                elif .sprint == "Sprint 2" then 2
                elif .sprint == "Sprint 3" then 3
                elif .sprint == "Sprint 4" then 4
                else 99 end
              )
            ) as $sprints |

            # Calculate milestone progress
            ($milestones | map({
              number: .number,
              title: .title,
              description: .description,
              open: .open_issues,
              closed: .closed_issues,
              progress: (if (.open_issues + .closed_issues) > 0
                then ((.closed_issues / (.open_issues + .closed_issues)) * 100 | floor)
                else 0 end),
              state: .state
            }) | sort_by(.number)) as $milestoneProgress |

            # Final structure
            {
              updated_at: (now | strftime("%Y-%m-%dT%H:%M:%SZ")),
              repository: "${{ github.repository }}",
              milestones: $milestoneProgress,
              sprints: $sprints,
              issues: $issues
            }
          ' > docs/roadmap-data.json

          echo "Generated roadmap-data.json:"
          cat docs/roadmap-data.json

      - name: Commit and Push Changes
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          # Check if there are changes
          if git diff --quiet docs/roadmap-data.json; then
            echo "No changes detected in roadmap-data.json"
            exit 0
          fi

          # Configure git with App identity
          git config user.name "OhMyDialog-Automation[bot]"
          git config user.email "automation@users.noreply.github.com"

          # Commit and push
          git add docs/roadmap-data.json
          git commit -m "docs(roadmap): actualizar datos del proyecto [skip ci]"
          git push

          echo "Changes committed and pushed successfully"

  # Job 2: Deploy to GitHub Pages
  deploy-pages:
    name: Deploy to GitHub Pages
    needs: update-roadmap
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: development

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'docs'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
