# Update Roadmap Data from GitHub Project
name: Update Roadmap

on:
  # Run when pushing to development (except auto-generated commits)
  push:
    branches: ["development"]
    paths-ignore:
      - 'docs/roadmap-data.json'

  # Manual trigger
  workflow_dispatch:

permissions:
  contents: write
  issues: read
  pull-requests: write
  repository-projects: read

jobs:
  update-roadmap:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: development

      - name: Generate Roadmap Data
        env:
          GH_TOKEN: ${{ secrets.PROJECT_TOKEN }}
        run: |
          # Fetch project items with custom fields via GraphQL
          PROJECT_DATA=$(gh api graphql -f query='
            query {
              node(id: "PVT_kwHOAVGx6s4BLOYT") {
                ... on ProjectV2 {
                  items(first: 100) {
                    nodes {
                      content {
                        ... on Issue {
                          number
                          title
                          state
                          milestone {
                            number
                            title
                          }
                          labels(first: 10) {
                            nodes {
                              name
                            }
                          }
                        }
                      }
                      fieldValues(first: 10) {
                        nodes {
                          ... on ProjectV2ItemFieldSingleSelectValue {
                            name
                            field {
                              ... on ProjectV2SingleSelectField {
                                name
                              }
                            }
                          }
                          ... on ProjectV2ItemFieldNumberValue {
                            number
                            field {
                              ... on ProjectV2Field {
                                name
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          ')

          # Fetch milestones via REST API
          MILESTONES=$(gh api repos/${{ github.repository }}/milestones --jq '[.[] | {
            number: .number,
            title: .title,
            description: .description,
            open_issues: .open_issues,
            closed_issues: .closed_issues,
            state: .state
          }]')

          # Process with jq to create the final JSON structure
          echo "$PROJECT_DATA" | jq --argjson milestones "$MILESTONES" '
            # Extract items from project
            .data.node.items.nodes as $items |

            # Process each item into a cleaner format
            [
              $items[] |
              select(.content != null) |
              {
                number: .content.number,
                title: .content.title,
                state: .content.state,
                milestone: .content.milestone.title,
                labels: [.content.labels.nodes[].name],
                fields: (
                  [.fieldValues.nodes[] | select(.field != null)] |
                  map({(.field.name): (.name // .number)}) |
                  add // {}
                )
              }
            ] as $issues |

            # Group by Sprint
            ($issues | group_by(.fields.Sprint) |
              map({
                sprint: (.[0].fields.Sprint // "Backlog"),
                issues: (. | sort_by(.fields.Order // 999))
              }) |
              sort_by(
                if .sprint == "Sprint 1" then 1
                elif .sprint == "Sprint 2" then 2
                elif .sprint == "Sprint 3" then 3
                elif .sprint == "Sprint 4" then 4
                else 99 end
              )
            ) as $sprints |

            # Calculate milestone progress
            ($milestones | map({
              number: .number,
              title: .title,
              description: .description,
              open: .open_issues,
              closed: .closed_issues,
              progress: (if (.open_issues + .closed_issues) > 0
                then ((.closed_issues / (.open_issues + .closed_issues)) * 100 | floor)
                else 0 end),
              state: .state
            }) | sort_by(.number)) as $milestoneProgress |

            # Final structure
            {
              updated_at: (now | strftime("%Y-%m-%dT%H:%M:%SZ")),
              repository: "${{ github.repository }}",
              milestones: $milestoneProgress,
              sprints: $sprints,
              issues: $issues
            }
          ' > docs/roadmap-data.json

          echo "Generated roadmap-data.json:"
          cat docs/roadmap-data.json

      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ secrets.PROJECT_TOKEN }}
        run: |
          # Check if there are changes
          if git diff --quiet docs/roadmap-data.json; then
            echo "No changes detected in roadmap-data.json"
            exit 0
          fi

          # Setup git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create unique branch name
          BRANCH_NAME="auto/roadmap-update-$(date +%Y%m%d-%H%M%S)"
          echo "Creating branch: $BRANCH_NAME"

          # Create and checkout new branch
          git checkout -b "$BRANCH_NAME"

          # Commit changes
          git add docs/roadmap-data.json
          git commit -m "docs(roadmap): actualizar datos del roadmap"

          # Push branch using token
          git remote set-url origin https://x-access-token:${{ secrets.PROJECT_TOKEN }}@github.com/${{ github.repository }}.git
          git push -u origin "$BRANCH_NAME"

          # Check if PR already exists
          EXISTING_PR=$(gh pr list --head "$BRANCH_NAME" --json number --jq '.[0].number' 2>/dev/null || echo "")

          if [ -n "$EXISTING_PR" ]; then
            echo "PR already exists: #$EXISTING_PR"
          else
            # Create PR
            gh pr create \
              --base development \
              --head "$BRANCH_NAME" \
              --title "docs(roadmap): actualizar datos del roadmap" \
              --body "$(cat <<'EOF'
          ## Actualizacion automatica del Roadmap

          Este PR fue generado automaticamente por el workflow de GitHub Actions.

          ### Cambios
          - Actualiza `docs/roadmap-data.json` con los datos mas recientes del Project Board

          ### Fuente de datos
          - GitHub Project: https://github.com/users/lobinuxsoft/projects/5
          - Milestones del repositorio

          ---
          *Generado automaticamente por GitHub Actions*
          EOF
          )"
            echo "PR created successfully"
          fi
